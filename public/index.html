<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Redis Subscriber 4</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: monospace; padding: 20px; }
  .channel { margin-bottom: 10px; }
  .controls { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; }
  input { padding: 5px; font-family: monospace; width: 300px; }
  textarea { padding: 5px; font-family: monospace; width: 100%; min-height: 100px; }
  button { padding: 5px 15px; cursor: pointer; margin-right: 5px; }
  .status { margin-top: 10px; color: green; }
  .section { margin-bottom: 15px; }
  label { display: block; margin-bottom: 5px; font-weight: bold; }
</style>
</head>
<body>
<h1>Redis Subscriber 4</h1>

<div class="controls">
  <div class="section">
    <label for="pattern">Subscription Pattern:</label>
    <input type="text" id="pattern" value="*" placeholder="e.g., c6c3_228.* or *">
    <button id="subscribe-pattern">Subscribe Pattern</button>
  </div>
  
  <!-- KEB Protocol Section (optional) -->
  <div class="section keb-nodes">
    <label>KEB Node Discovery:</label>
    <button id="discover-nodes">Discover Nodes</button>
    <div id="discovered-list" style="margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; display: none;"></div>
    
    <label for="nodes" style="margin-top: 15px;">Selected Nodes (one per line):</label>
    <textarea id="nodes" placeholder="Click 'Discover Nodes' to find available nodes, then select from the list above"></textarea>
    <button id="subscribe-nodes">Subscribe Nodes</button>
  </div>
  
  <div class="status" id="status"></div>
</div>

<div id="messages"></div>

<script>
  const socket = io();

  socket.on('redis-message', ({ channel, message }) => {
    const div = document.createElement('div');
    div.className = 'channel';
    div.textContent = `${channel} : ${message}`;
    document.getElementById('messages').prepend(div);
  });

  socket.on('subscription-status', ({ pattern, status }) => {
    document.getElementById('status').textContent = `Status: ${status} - Pattern: ${pattern}`;
  });

  // Pattern subscription
  document.getElementById('subscribe-pattern').addEventListener('click', () => {
    const pattern = document.getElementById('pattern').value || '*';
    socket.emit('change-pattern', pattern);
  });

  // Request current state on load
  socket.on('connect', () => {
    socket.emit('get-current-pattern');
  });

  socket.on('current-pattern', (pattern) => {
    document.getElementById('pattern').value = pattern;
    document.getElementById('status').textContent = `Status: Subscribed - Pattern: ${pattern}`;
  });

  // ============================================================================
  // OPTIONAL: KEB Protocol Client Code
  // ============================================================================
  let kebProtocolEnabled = false;
  let discoveredNodes = [];

  socket.on('keb-protocol-enabled', (enabled) => {
    kebProtocolEnabled = enabled;
    // Show/hide KEB section based on server support
    const kebSection = document.querySelector('.section.keb-nodes');
    if (kebSection) {
      kebSection.style.display = enabled ? 'block' : 'none';
    }
  });

  // Handle node discovery
  document.getElementById('discover-nodes').addEventListener('click', () => {
    if (!kebProtocolEnabled) return;
    socket.emit('discover-nodes');
  });

  socket.on('discovered-nodes', (nodes) => {
    discoveredNodes = nodes;
    const listDiv = document.getElementById('discovered-list');
    
    if (nodes.length === 0) {
      listDiv.style.display = 'none';
      return;
    }
    
    listDiv.style.display = 'block';
    listDiv.innerHTML = '<div style="font-weight: bold; margin-bottom: 5px;">Click nodes to add:</div>';
    
    nodes.forEach(node => {
      const nodeDiv = document.createElement('div');
      nodeDiv.textContent = node;
      nodeDiv.style.cursor = 'pointer';
      nodeDiv.style.padding = '3px';
      nodeDiv.style.borderBottom = '1px solid #eee';
      nodeDiv.addEventListener('click', () => {
        const currentNodes = document.getElementById('nodes').value;
        const nodeList = currentNodes ? currentNodes.split('\n') : [];
        if (!nodeList.includes(node)) {
          nodeList.push(node);
          document.getElementById('nodes').value = nodeList.join('\n');
        }
      });
      nodeDiv.addEventListener('mouseenter', () => {
        nodeDiv.style.backgroundColor = '#e0e0e0';
      });
      nodeDiv.addEventListener('mouseleave', () => {
        nodeDiv.style.backgroundColor = 'transparent';
      });
      listDiv.appendChild(nodeDiv);
    });
  });

  // KEB node subscription
  document.getElementById('subscribe-nodes').addEventListener('click', () => {
    if (!kebProtocolEnabled) return;
    const nodesText = document.getElementById('nodes').value;
    const nodes = nodesText.split('\n').map(n => n.trim()).filter(n => n.length > 0);
    if (nodes.length > 0) {
      socket.emit('subscribe-nodes', nodes);
    }
  });

  socket.on('subscribed-nodes', (nodes) => {
    if (nodes.length > 0) {
      document.getElementById('nodes').value = nodes.join('\n');
    }
  });
  // ============================================================================
  // END KEB PROTOCOL CLIENT CODE
  // ============================================================================
</script>
</body>
</html>